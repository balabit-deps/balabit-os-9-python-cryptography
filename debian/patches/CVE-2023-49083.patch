Backport of:

From f09c261ca10a31fe41b1262306db7f8f1da0e48a Mon Sep 17 00:00:00 2001
From: Alex Gaynor <alex.gaynor@gmail.com>
Date: Mon, 27 Nov 2023 14:35:35 -0500
Subject: [PATCH] 41.0.6 release (#9927)

* Fixed crash when loading a PKCS#7 bundle with no certificates (#9926)

* Version bump for 41.0.6

* Temporarily allow a new clippy warning (#9835)

* Temporarily allow a new clippy warning

* Update lib.rs

* Update lib.rs

* Need to accept this to skip test

* It's a word
---
 CHANGELOG.rst                                       | 9 +++++++++
 docs/spelling_wordlist.txt                          | 1 +
 pyproject.toml                                      | 2 +-
 src/cryptography/__about__.py                       | 2 +-
 src/cryptography/hazmat/backends/openssl/backend.py | 5 ++++-
 src/rust/src/lib.rs                                 | 2 ++
 tests/hazmat/primitives/test_pkcs7.py               | 6 ++++++
 vectors/cryptography_vectors/__about__.py           | 2 +-
 vectors/pyproject.toml                              | 2 +-
 9 files changed, 26 insertions(+), 5 deletions(-)

--- a/src/cryptography/hazmat/backends/openssl/backend.py
+++ b/src/cryptography/hazmat/backends/openssl/backend.py
@@ -2666,9 +2666,12 @@ class Backend(object):
                 _Reasons.UNSUPPORTED_SERIALIZATION,
             )
 
+        certs: list[x509.Certificate] = []
+        if p7.d.sign == self._ffi.NULL:
+            return certs
+
         sk_x509 = p7.d.sign.cert
         num = self._lib.sk_X509_num(sk_x509)
-        certs = []
         for i in range(num):
             x509 = self._lib.sk_X509_value(sk_x509, i)
             self.openssl_assert(x509 != self._ffi.NULL)
--- a/tests/hazmat/primitives/test_pkcs7.py
+++ b/tests/hazmat/primitives/test_pkcs7.py
@@ -78,6 +78,12 @@ class TestPKCS7Loading(object):
                 mode="rb",
             )
 
+    def test_load_pkcs7_empty_certificates(self, backend):
+        der = b"\x30\x0B\x06\x09\x2A\x86\x48\x86\xF7\x0D\x01\x07\x02"
+
+        certificates = pkcs7.load_der_pkcs7_certificates(der)
+        assert certificates == []
+
 
 # We have no public verification API and won't be adding one until we get
 # some requirements from users so this function exists to give us basic
